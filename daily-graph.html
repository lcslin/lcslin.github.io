<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITIS 每日新聞關聯圖譜</title>
    <script src="https://unpkg.com/d3"></script>
    <script src="https://unpkg.com/force-graph"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0b0b0b;
            --text-color: #e0e0e0;
            --accent-color: #ff9900; /* Cosmic Orange */
            --node-bg: #1a1a1a;
            --node-border: #ff9900;
            --link-color: rgba(255, 153, 0, 0.4);
            --dim-color: rgba(255, 255, 255, 0.1);
        }

        body { 
            margin: 0; 
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden; 
        }

        #graph { 
            width: 100vw; 
            height: 100vh; 
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(11, 11, 11, 0.9);
            border: 1px solid var(--accent-color);
            padding: 20px;
            width: 280px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: transform 0.25s ease;
        }
        .controls.hidden {
            transform: translateX(calc(-100% - 40px));
        }
        .controls .toggle-panel-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
            cursor: pointer;
            padding: 10px 12px;
            min-width: 44px;
            min-height: 44px;
            font-size: 0.9rem;
            border-radius: 4px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .controls .toggle-panel-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .controls-toggle-tab {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 99;
            display: none;
            padding: 14px 12px;
            min-width: 44px;
            min-height: 44px;
            background: rgba(11, 11, 11, 0.95);
            border: 1px solid var(--accent-color);
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            box-shadow: 2px 0 8px rgba(0,0,0,0.3);
            align-items: center;
            justify-content: center;
        }
        .controls-toggle-tab:hover {
            background: rgba(26, 26, 26, 0.98);
        }
        .controls-toggle-tab.visible {
            display: flex;
        }

        .controls h1 {
            margin: 0 30px 15px 0;
            font-size: 1.2rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 10px;
        }

        p {
            font-size: 0.9rem;
            line-height: 1.5;
            color: #aaa;
            margin-bottom: 10px;
        }

        select, input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            background: #222;
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            margin-top: 5px;
            margin-bottom: 20px;
            font-family: inherit;
            outline: none;
        }
        
        select:hover, input[type="text"]:hover {
            background: #333;
        }

        #keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .keyword-tag {
            font-size: 0.8rem;
            padding: 4px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: #ccc;
            background: rgba(255,255,255,0.05);
        }

        .keyword-tag:hover {
            border-color: var(--accent-color);
            color: #fff;
        }

        .keyword-tag.active {
            background: var(--accent-color);
            color: #000;
            border-color: var(--accent-color);
            font-weight: bold;
        }

        .node-label {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 2px 5px;
            font-size: 12px;
            pointer-events: none;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--accent-color);
            font-size: 1.5rem;
            display: none;
        }

        #toast {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid var(--accent-color);
            padding: 15px 25px;
            border-radius: 4px;
            color: #fff;
            display: none;
            z-index: 200;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.2);
        }
        
        #toast h3 {
            margin: 0 0 5px 0;
            color: var(--accent-color);
            font-size: 1rem;
        }

        #news-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            max-height: 85vh;
            background: rgba(11, 11, 11, 0.95);
            border: 1px solid var(--accent-color);
            padding: 15px;
            border-radius: 4px;
            display: none;
            z-index: 150;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #news-panel.visible { display: block; }
        #news-panel h3 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
            font-size: 1rem;
            padding-right: 28px;
        }
        #news-panel .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
            cursor: pointer;
            padding: 2px 8px;
            font-size: 0.9rem;
            border-radius: 4px;
        }
        #news-panel .close-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        #news-panel .news-list {
            overflow-y: auto;
            max-height: calc(85vh - 60px);
        }
        #news-panel .news-item {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            font-size: 0.85rem;
        }
        #news-panel .news-item:last-child { border-bottom: none; }
        #news-panel .news-item a {
            color: var(--accent-color);
            text-decoration: none;
        }
        #news-panel .news-item a:hover { text-decoration: underline; }
        #news-panel .news-item .source { color: #888; font-size: 0.8rem; }

    </style>
</head>
<body>
    <div class="controls" id="controls-panel">
        <button type="button" class="toggle-panel-btn" id="toggle-panel-btn" aria-label="收合側欄">◀ 收合</button>
        <h1>每日新聞關聯圖譜</h1>
        <p>節點：實體 (點擊查看相關新聞)</p>
        <p>連線：實體關係 (點擊查看類型)</p>
        
        <select id="date-selector">
            <option value="" disabled selected>選擇日期...</option>
        </select>
        
        <p style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; color: var(--accent-color);">搜尋標題</p>
        <input type="text" id="search-input" placeholder="輸入關鍵字...">
        
        <p style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; color: var(--accent-color);">關鍵字篩選</p>
        <div id="keyword-list"></div>
    </div>
    
    <button type="button" class="controls-toggle-tab" id="controls-toggle-tab" aria-label="開啟側欄">▶ 開啟</button>
    <div id="loading">載入資料中...</div>
    <div id="toast"></div>
    <div id="news-panel">
        <button class="close-btn" type="button" aria-label="關閉">×</button>
        <h3 id="news-panel-title"></h3>
        <div class="news-list" id="news-panel-list"></div>
    </div>
    <div id="graph"></div>

    <script>
        const graphContainer = document.getElementById('graph');
        const dateSelector = document.getElementById('date-selector');
        const searchInput = document.getElementById('search-input');
        const keywordList = document.getElementById('keyword-list');
        const loading = document.getElementById('loading');
        const toast = document.getElementById('toast');
        
        // 1. Target Date (replaced by build, or use today when opening template directly)
        const TARGET_DATE_RAW = "2026-02-13";
        const TARGET_DATE = /^__.+\__$/.test(TARGET_DATE_RAW) ? (function () {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        })() : TARGET_DATE_RAW;

        // 2. Embedded Data (replaced by build; fallback when opening template directly)
        let EMBEDDED_DATA;
        try {
            EMBEDDED_DATA = {"nodes": [{"id": "川普", "group": "person", "size": 20}, {"id": "央行", "group": "org", "size": 18}, {"id": "美國", "group": "country", "size": 22}, {"id": "台灣", "group": "country", "size": 25}, {"id": "AI", "group": "tech", "size": 24}, {"id": "鴻海", "group": "company", "size": 16}, {"id": "劉揚偉", "group": "person", "size": 12}, {"id": "廣達", "group": "company", "size": 14}, {"id": "華碩", "group": "company", "size": 14}, {"id": "Meta", "group": "company", "size": 15}, {"id": "輝達", "group": "company", "size": 13}, {"id": "黃仁勳", "group": "person", "size": 10}, {"id": "卓揆", "group": "person", "size": 13}, {"id": "關稅", "group": "finance", "size": 18}, {"id": "GDP", "group": "finance", "size": 15}, {"id": "通膨", "group": "finance", "size": 12}, {"id": "台幣", "group": "finance", "size": 13}, {"id": "加拿大", "group": "country", "size": 14}, {"id": "印度", "group": "country", "size": 10}, {"id": "中國", "group": "country", "size": 16}, {"id": "伺服器", "group": "tech", "size": 16}, {"id": "半導體", "group": "tech", "size": 18}, {"id": "記憶體", "group": "tech", "size": 13}, {"id": "群創", "group": "company", "size": 12}, {"id": "日月光", "group": "company", "size": 11}, {"id": "南茂", "group": "company", "size": 10}, {"id": "中小企業", "group": "org", "size": 12}, {"id": "最低工資", "group": "finance", "size": 11}, {"id": "美光", "group": "company", "size": 12}, {"id": "HBM", "group": "tech", "size": 11}, {"id": "泰國", "group": "country", "size": 11}, {"id": "聯發科", "group": "company", "size": 11}, {"id": "新唐", "group": "company", "size": 10}, {"id": "采鈺", "group": "company", "size": 10}, {"id": "蘋果", "group": "company", "size": 11}, {"id": "馬斯克", "group": "person", "size": 10}, {"id": "貿易協定", "group": "finance", "size": 12}, {"id": "美豬", "group": "finance", "size": 10}, {"id": "新加坡", "group": "country", "size": 9}, {"id": "核能", "group": "tech", "size": 10}, {"id": "韓國", "group": "country", "size": 9}, {"id": "應材", "group": "company", "size": 10}, {"id": "資料中心", "group": "tech", "size": 13}, {"id": "緯創", "group": "company", "size": 10}, {"id": "英業達", "group": "company", "size": 10}, {"id": "仁寶", "group": "company", "size": 10}], "links": [{"source": "川普", "target": "關稅", "value": 5, "label": "政策制定"}, {"source": "川普", "target": "加拿大", "value": 4, "label": "貿易衝突"}, {"source": "川普", "target": "美國", "value": 5, "label": "國家領導"}, {"source": "央行", "target": "通膨", "value": 5, "label": "貨幣政策"}, {"source": "央行", "target": "台幣", "value": 4, "label": "匯率管理"}, {"source": "央行", "target": "台灣", "value": 5, "label": "金融監管"}, {"source": "美國", "target": "GDP", "value": 4, "label": "經濟指標"}, {"source": "美國", "target": "關稅", "value": 5, "label": "貿易政策"}, {"source": "台灣", "target": "GDP", "value": 4, "label": "經濟成長"}, {"source": "台灣", "target": "半導體", "value": 5, "label": "產業優勢"}, {"source": "台灣", "target": "AI", "value": 5, "label": "科技發展"}, {"source": "卓揆", "target": "台灣", "value": 5, "label": "政府領導"}, {"source": "卓揆", "target": "GDP", "value": 4, "label": "經濟目標"}, {"source": "卓揆", "target": "最低工資", "value": 4, "label": "政策推動"}, {"source": "卓揆", "target": "中小企業", "value": 4, "label": "產業扶持"}, {"source": "AI", "target": "伺服器", "value": 5, "label": "技術應用"}, {"source": "AI", "target": "資料中心", "value": 5, "label": "基礎建設"}, {"source": "AI", "target": "半導體", "value": 5, "label": "技術支撐"}, {"source": "鴻海", "target": "劉揚偉", "value": 5, "label": "企業領導"}, {"source": "鴻海", "target": "台灣", "value": 4, "label": "產業貢獻"}, {"source": "鴻海", "target": "AI", "value": 4, "label": "技術投資"}, {"source": "廣達", "target": "泰國", "value": 4, "label": "海外擴產"}, {"source": "廣達", "target": "AI", "value": 4, "label": "產品供應"}, {"source": "廣達", "target": "伺服器", "value": 5, "label": "製造生產"}, {"source": "華碩", "target": "伺服器", "value": 5, "label": "產品業務"}, {"source": "華碩", "target": "AI", "value": 4, "label": "技術布局"}, {"source": "華碩", "target": "美國", "value": 3, "label": "製造擴張"}, {"source": "Meta", "target": "AI", "value": 5, "label": "技術投資"}, {"source": "Meta", "target": "資料中心", "value": 5, "label": "基建投資"}, {"source": "Meta", "target": "緯創", "value": 3, "label": "供應鏈"}, {"source": "Meta", "target": "英業達", "value": 3, "label": "供應鏈"}, {"source": "Meta", "target": "仁寶", "value": 3, "label": "供應鏈"}, {"source": "輝達", "target": "AI", "value": 5, "label": "技術領導"}, {"source": "輝達", "target": "中國", "value": 3, "label": "市場限制"}, {"source": "輝達", "target": "黃仁勳", "value": 5, "label": "企業領導"}, {"source": "黃仁勳", "target": "AI", "value": 5, "label": "產業推動"}, {"source": "群創", "target": "日月光", "value": 4, "label": "資產交易"}, {"source": "群創", "target": "南茂", "value": 4, "label": "資產交易"}, {"source": "群創", "target": "台灣", "value": 3, "label": "產業重組"}, {"source": "美光", "target": "HBM", "value": 5, "label": "產品供應"}, {"source": "美光", "target": "記憶體", "value": 5, "label": "製造生產"}, {"source": "美光", "target": "AI", "value": 4, "label": "技術支援"}, {"source": "HBM", "target": "記憶體", "value": 5, "label": "技術類別"}, {"source": "HBM", "target": "AI", "value": 5, "label": "關鍵技術"}, {"source": "聯發科", "target": "AI", "value": 5, "label": "超算中心"}, {"source": "聯發科", "target": "台灣", "value": 4, "label": "產業投資"}, {"source": "新唐", "target": "半導體", "value": 4, "label": "產品供應"}, {"source": "采鈺", "target": "半導體", "value": 4, "label": "製造生產"}, {"source": "采鈺", "target": "台灣", "value": 3, "label": "產業貢獻"}, {"source": "蘋果", "target": "AI", "value": 3, "label": "產品升級"}, {"source": "馬斯克", "target": "AI", "value": 4, "label": "企業布局"}, {"source": "印度", "target": "貿易協定", "value": 4, "label": "勞工抗議"}, {"source": "貿易協定", "target": "台灣", "value": 4, "label": "經濟談判"}, {"source": "貿易協定", "target": "美國", "value": 4, "label": "經濟談判"}, {"source": "美豬", "target": "貿易協定", "value": 4, "label": "市場開放"}, {"source": "美豬", "target": "台灣", "value": 3, "label": "進口影響"}, {"source": "新加坡", "target": "AI", "value": 3, "label": "產業發展"}, {"source": "中國", "target": "AI", "value": 4, "label": "技術競爭"}, {"source": "中國", "target": "半導體", "value": 4, "label": "產業限制"}, {"source": "應材", "target": "中國", "value": 4, "label": "出口違規"}, {"source": "應材", "target": "韓國", "value": 3, "label": "繞道貿易"}, {"source": "應材", "target": "美國", "value": 4, "label": "監管處罰"}, {"source": "川普", "target": "核能", "value": 3, "label": "能源政策"}, {"source": "半導體", "target": "台灣", "value": 5, "label": "矽盾戰略"}, {"source": "最低工資", "target": "台灣", "value": 4, "label": "勞工政策"}, {"source": "中小企業", "target": "台灣", "value": 4, "label": "產業轉型"}, {"source": "關稅", "target": "貿易協定", "value": 5, "label": "經濟工具"}], "newsDatabase": {"川普": [{"title": "當初為何加瑞士關稅？ 川普：我不喜歡他們講話態度", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/124373/9327574"}, {"title": "共和黨黨內造反…挑戰川普政策 眾院撤銷對加拿大徵關稅", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/124373/9327572"}, {"title": "川普挺煤電 要國防部採購 指示與發電廠訂定長期協議", "source": "經濟國際焦點", "url": "https://money.udn.com/money/story/5599/9327522"}, {"title": "推乾淨燃煤 川普令戰爭部簽煤電長約", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000276-260203?utm_source=iii_news&utm_medium=rss"}], "央行": [{"title": "貨幣政策…央行表態 不再只盯2%通膨率", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/7238/9327653"}, {"title": "當前貨幣政策 央行：順暢", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000193-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "央行貨幣政策檢視報告 有三考量", "source": "工商金融稅務", "url": "https://www.chinatimes.com/newspapers/20260213000309-260205?utm_source=iii_news&utm_medium=rss"}, {"title": "我貨幣4大特點 因應外部衝擊", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743693"}], "美國": [{"title": "美年度赤字恐逾1.8兆美元", "source": "經濟國際焦點", "url": "https://money.udn.com/money/story/5599/9327526"}, {"title": "美國債務占GDP比重 2036年恐升至120％", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000199-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "外匯存底偏重美元 三因素", "source": "經濟金融脈動", "url": "https://money.udn.com/money/story/5613/9327475"}, {"title": "美眾院通過撤銷加國關稅案", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000278-260203?utm_source=iii_news&utm_medium=rss"}, {"title": "占比僅2.4％ 去年美製車來台不到萬輛", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743667"}], "台灣": [{"title": "卓揆：台灣人均GDP今年定達4萬美元", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000204-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "台幣蛇年封關 估終結連三年收貶", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000234-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "出口持續爆發 今年GDP可望大幅上修", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743694"}, {"title": "封關前夕 台幣一度升1角", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/7239/9327568"}, {"title": "賴總統確保台灣矽盾", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000190-260202?utm_source=iii_news&utm_medium=rss"}], "AI": [{"title": "Meta AI大基建 台鏈進補 緯創、英業達、仁寶等接單動能看增", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327607"}, {"title": "2,000億！華碩伺服器拚績增五成 預期AI推論商機來了", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327610"}, {"title": "星國喊打造全球 AI 中心", "source": "經濟國際焦點", "url": "https://money.udn.com/money/story/5599/9327527"}, {"title": "AI助招募「更專注人才本質」", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/7238/9327636"}, {"title": "拚AI算力 Meta再砸百億美元建大型資料中心", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000282-260203?utm_source=iii_news&utm_medium=rss"}, {"title": "AI激戰 陸科企大模型升級", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000291-260203?utm_source=iii_news&utm_medium=rss"}, {"title": "AI發威 聯想去年Q4營收創高", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000295-260203?utm_source=iii_news&utm_medium=rss"}, {"title": "聯發科創意 自建AI超算中心", "source": "工商產業科技", "url": "https://www.chinatimes.com/newspapers/20260213000317-260204?utm_source=iii_news&utm_medium=rss"}, {"title": "AI走入實體成新變革", "source": "工商產業科技", "url": "https://www.chinatimes.com/newspapers/20260213000327-260204?utm_source=iii_news&utm_medium=rss"}, {"title": "黃仁勳：AI是史上最大規模基建", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743691"}, {"title": "AI助攻經濟 93％勞工不滿目前薪資", "source": "中時財經新聞", "url": "https://www.chinatimes.com/newspapers/20260213000527-260110?utm_source=iii_news&utm_medium=rss"}], "鴻海": [{"title": "郭台銘尾牙加碼3億 鴻海十員工 抽到千萬紅包", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327614"}, {"title": "鴻海金馬年 營收衝9兆 董座劉揚偉喊「絕對比去年好很多」", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327562"}, {"title": "劉揚偉：今年絕對大勝去年", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000214-260202?utm_source=iii_news&utm_medium=rss"}], "劉揚偉": [{"title": "鴻海金馬年 營收衝9兆 董座劉揚偉喊「絕對比去年好很多」", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327562"}, {"title": "劉揚偉：今年絕對大勝去年", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000214-260202?utm_source=iii_news&utm_medium=rss"}], "廣達": [{"title": "廣達砸10億 泰國擴產", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327609"}, {"title": "海外布局再下一城 廣達斥11億加碼泰國擴產", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000217-260202?utm_source=iii_news&utm_medium=rss"}], "華碩": [{"title": "2,000億！華碩伺服器拚績增五成 預期AI推論商機來了", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327610"}, {"title": "衝刺AI伺服器業務 華碩下波成長放眼美國製造", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000219-260202?utm_source=iii_news&utm_medium=rss"}], "Meta": [{"title": "Meta AI大基建 台鏈進補 緯創、英業達、仁寶等接單動能看增", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327607"}, {"title": "拚AI算力 Meta再砸百億美元建大型資料中心", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000282-260203?utm_source=iii_news&utm_medium=rss"}], "輝達": [{"title": "輝達中國特供版顯卡 市場不買單", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000294-260203?utm_source=iii_news&utm_medium=rss"}], "黃仁勳": [{"title": "黃仁勳：AI是史上最大規模基建", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743691"}], "卓揆": [{"title": "卓揆：台灣人均GDP今年定達4萬美元", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000204-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "卓揆喊話 明年最低工資衝3萬", "source": "中時財經新聞", "url": "https://www.chinatimes.com/newspapers/20260213000525-260110?utm_source=iii_news&utm_medium=rss"}], "關稅": [{"title": "當初為何加瑞士關稅？ 川普：我不喜歡他們講話態度", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/124373/9327574"}, {"title": "共和黨黨內造反…挑戰川普政策 眾院撤銷對加拿大徵關稅", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/124373/9327572"}, {"title": "美眾院通過撤銷加國關稅案", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000278-260203?utm_source=iii_news&utm_medium=rss"}, {"title": "化工品遭美課反傾銷稅", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327531"}], "GDP": [{"title": "卓揆：台灣人均GDP今年定達4萬美元", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000204-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "美國債務占GDP比重 2036年恐升至120％", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000199-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "出口持續爆發 今年GDP可望大幅上修", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743694"}], "通膨": [{"title": "貨幣政策…央行表態 不再只盯2%通膨率", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/7238/9327653"}], "台幣": [{"title": "台幣蛇年封關 估終結連三年收貶", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000234-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "封關前夕 台幣一度升1角", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/7239/9327568"}], "加拿大": [{"title": "共和黨黨內造反…挑戰川普政策 眾院撤銷對加拿大徵關稅", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/124373/9327572"}, {"title": "美眾院通過撤銷加國關稅案", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000278-260203?utm_source=iii_news&utm_medium=rss"}], "印度": [{"title": "不滿貿易協議…10工會串聯 印度3億人全國大罷工", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/124373/9327582"}], "中國": [{"title": "輸中「繞道韓國」沒用！應材遭美罰重金", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000225-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "輝達中國特供版顯卡 市場不買單", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000294-260203?utm_source=iii_news&utm_medium=rss"}, {"title": "AI激戰 陸科企大模型升級", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000291-260203?utm_source=iii_news&utm_medium=rss"}], "伺服器": [{"title": "2,000億！華碩伺服器拚績增五成 預期AI推論商機來了", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327610"}, {"title": "衝刺AI伺服器業務 華碩下波成長放眼美國製造", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000219-260202?utm_source=iii_news&utm_medium=rss"}], "半導體": [{"title": "賴總統確保台灣矽盾", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000190-260202?utm_source=iii_news&utm_medium=rss"}], "記憶體": [{"title": "記憶體價飆衝擊毛利率 思科股價重挫", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000287-260203?utm_source=iii_news&utm_medium=rss"}], "群創": [{"title": "群創售廠 南茂、日月光有興趣 傳看上南科二廠及五廠", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327503"}, {"title": "群創南科5廠 市場點名買家是日月光", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743692"}], "日月光": [{"title": "群創售廠 南茂、日月光有興趣 傳看上南科二廠及五廠", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327503"}, {"title": "群創南科5廠 市場點名買家是日月光", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743692"}], "南茂": [{"title": "群創售廠 南茂、日月光有興趣 傳看上南科二廠及五廠", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327503"}], "中小企業": [{"title": "經部射四箭 助中小微企轉型", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000207-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "政院4隻箭 助中小微企業升級 4年投入42.5億 強化數位與淨零轉型", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743669"}], "最低工資": [{"title": "最低工資破3萬 工商界憂物價狂飆", "source": "中時財經新聞", "url": "https://www.chinatimes.com/newspapers/20260213000529-260110?utm_source=iii_news&utm_medium=rss"}, {"title": "卓揆喊話 明年最低工資衝3萬", "source": "中時財經新聞", "url": "https://www.chinatimes.com/newspapers/20260213000525-260110?utm_source=iii_news&utm_medium=rss"}], "美光": [{"title": "美光財務長：HBM4已出貨 強調產能供不應求", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000226-260202?utm_source=iii_news&utm_medium=rss"}], "HBM": [{"title": "美光財務長：HBM4已出貨 強調產能供不應求", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000226-260202?utm_source=iii_news&utm_medium=rss"}], "泰國": [{"title": "廣達砸10億 泰國擴產", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327609"}, {"title": "海外布局再下一城 廣達斥11億加碼泰國擴產", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000217-260202?utm_source=iii_news&utm_medium=rss"}], "聯發科": [{"title": "聯發科創意 自建AI超算中心", "source": "工商產業科技", "url": "https://www.chinatimes.com/newspapers/20260213000317-260204?utm_source=iii_news&utm_medium=rss"}], "新唐": [{"title": "新唐報喜 BMC訂單看到年底", "source": "工商產業科技", "url": "https://www.chinatimes.com/newspapers/20260213000326-260204?utm_source=iii_news&utm_medium=rss"}, {"title": "新唐樂觀 MCU 市況", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/7253/9327251"}], "采鈺": [{"title": "采鈺H1穩健 毛利率回神", "source": "工商產業科技", "url": "https://www.chinatimes.com/newspapers/20260213000320-260204?utm_source=iii_news&utm_medium=rss"}, {"title": "采鈺2025年每股賺4.01元 將配息3元 調高2026年資本支出", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/7253/9327250"}], "蘋果": [{"title": "測試階段受挫 蘋果Siri升級再延期", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000285-260203?utm_source=iii_news&utm_medium=rss"}], "馬斯克": [{"title": "馬斯克重組xAI四大團隊 推Macrohard叫陣微軟", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000289-260203?utm_source=iii_news&utm_medium=rss"}], "貿易協定": [{"title": "不滿貿易協議…10工會串聯 印度3億人全國大罷工", "source": "聯合_產經_股市", "url": "https://udn.com/news/story/124373/9327582"}, {"title": "台美簽署貿易協定 美豬降關稅衝擊大？ 美豬開放4年 國產豬穩守9成市占", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743666"}], "美豬": [{"title": "業界：美豬難撼台豬市場", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000212-260202?utm_source=iii_news&utm_medium=rss"}, {"title": "台美簽署貿易協定 美豬降關稅衝擊大？ 美豬開放4年 國產豬穩守9成市占", "source": "自由時報財經新聞", "url": "https://ec.ltn.com.tw/article/paper/1743666"}], "新加坡": [{"title": "星國喊打造全球 AI 中心", "source": "經濟國際焦點", "url": "https://money.udn.com/money/story/5599/9327527"}], "核能": [{"title": "政院強調核能三原則》高階核廢料選址條例 草擬中", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000213-260202?utm_source=iii_news&utm_medium=rss"}], "韓國": [{"title": "輸中「繞道韓國」沒用！應材遭美罰重金", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000225-260202?utm_source=iii_news&utm_medium=rss"}], "應材": [{"title": "輸中「繞道韓國」沒用！應材遭美罰重金", "source": "工商財經要聞", "url": "https://www.chinatimes.com/newspapers/20260213000225-260202?utm_source=iii_news&utm_medium=rss"}], "資料中心": [{"title": "拚AI算力 Meta再砸百億美元建大型資料中心", "source": "工商全球財經", "url": "https://www.chinatimes.com/newspapers/20260213000282-260203?utm_source=iii_news&utm_medium=rss"}], "緯創": [{"title": "Meta AI大基建 台鏈進補 緯創、英業達、仁寶等接單動能看增", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327607"}], "英業達": [{"title": "Meta AI大基建 台鏈進補 緯創、英業達、仁寶等接單動能看增", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327607"}], "仁寶": [{"title": "Meta AI大基建 台鏈進補 緯創、英業達、仁寶等接單動能看增", "source": "經濟產業熱點", "url": "https://money.udn.com/money/story/5612/9327607"}]}, "titleToUrl": {"外匯存底偏重美元 三因素 (經濟金融脈動)": "https://money.udn.com/money/story/5613/9327475", "美年度赤字恐逾1.8兆美元 (經濟國際焦點)": "https://money.udn.com/money/story/5599/9327526", "貨幣政策…央行表態 不再只盯2%通膨率 (聯合_產經_股市)": "https://udn.com/news/story/7238/9327653", "當初為何加瑞士關稅？ 川普：我不喜歡他們講話態度 (聯合_產經_股市)": "https://udn.com/news/story/124373/9327574", "不滿貿易協議…10工會串聯 印度3億人全國大罷工 (聯合_產經_股市)": "https://udn.com/news/story/124373/9327582", "共和黨黨內造反…挑戰川普政策 眾院撤銷對加拿大徵關稅 (聯合_產經_股市)": "https://udn.com/news/story/124373/9327572", "高市早苗拚經濟 國防支出是關鍵 (聯合_產經_股市)": "https://udn.com/news/story/6811/9327644", "當前貨幣政策 央行：順暢 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000193-260202?utm_source=iii_news&utm_medium=rss", "美國債務占GDP比重 2036年恐升至120％ (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000199-260202?utm_source=iii_news&utm_medium=rss", "卓揆：台灣人均GDP今年定達4萬美元 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000204-260202?utm_source=iii_news&utm_medium=rss", "經部射四箭 助中小微企轉型 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000207-260202?utm_source=iii_news&utm_medium=rss", "台幣蛇年封關 估終結連三年收貶 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000234-260202?utm_source=iii_news&utm_medium=rss", "美眾院通過撤銷加國關稅案 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000278-260203?utm_source=iii_news&utm_medium=rss", "央行貨幣政策檢視報告 有三考量 (工商金融稅務)": "https://www.chinatimes.com/newspapers/20260213000309-260205?utm_source=iii_news&utm_medium=rss", "年關到 定存單標售急凍 364天期定存單利率升至1.275％ (工商金融稅務)": "https://www.chinatimes.com/newspapers/20260213000315-260205?utm_source=iii_news&utm_medium=rss", "AI助攻經濟 93％勞工不滿目前薪資 (中時財經新聞)": "https://www.chinatimes.com/newspapers/20260213000527-260110?utm_source=iii_news&utm_medium=rss", "最低工資破3萬 工商界憂物價狂飆 (中時財經新聞)": "https://www.chinatimes.com/newspapers/20260213000529-260110?utm_source=iii_news&utm_medium=rss", "政院4隻箭 助中小微企業升級 4年投入42.5億 強化數位與淨零轉型 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743669", "出口持續爆發 今年GDP可望大幅上修 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743694", "我貨幣4大特點 因應外部衝擊 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743693", "封關前夕 台幣一度升1角 (聯合_產經_股市)": "https://udn.com/news/story/7239/9327568", "Meta AI大基建 台鏈進補 緯創、英業達、仁寶等接單動能看增 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327607", "廣達砸10億 泰國擴產 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327609", "2,000億！華碩伺服器拚績增五成 預期AI推論商機來了 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327610", "郭台銘尾牙加碼3億 鴻海十員工 抽到千萬紅包 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327614", "群創售廠 南茂、日月光有興趣 傳看上南科二廠及五廠 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327503", "鴻海金馬年 營收衝9兆 董座劉揚偉喊「絕對比去年好很多」 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327562", "化工品遭美課反傾銷稅 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327531", "中華開發資本聚焦科技新創 (經濟金融脈動)": "https://money.udn.com/money/story/5613/9327485", "星國喊打造全球 AI 中心 (經濟國際焦點)": "https://money.udn.com/money/story/5599/9327527", "AI助招募「更專注人才本質」 (聯合_產經_股市)": "https://udn.com/news/story/7238/9327636", "賴總統確保台灣矽盾 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000190-260202?utm_source=iii_news&utm_medium=rss", "劉揚偉：今年絕對大勝去年 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000214-260202?utm_source=iii_news&utm_medium=rss", "海外布局再下一城 廣達斥11億加碼泰國擴產 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000217-260202?utm_source=iii_news&utm_medium=rss", "衝刺AI伺服器業務 華碩下波成長放眼美國製造 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000219-260202?utm_source=iii_news&utm_medium=rss", "輸中「繞道韓國」沒用！應材遭美罰重金 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000225-260202?utm_source=iii_news&utm_medium=rss", "美光財務長：HBM4已出貨 強調產能供不應求 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000226-260202?utm_source=iii_news&utm_medium=rss", "拚AI算力 Meta再砸百億美元建大型資料中心 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000282-260203?utm_source=iii_news&utm_medium=rss", "測試階段受挫 蘋果Siri升級再延期 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000285-260203?utm_source=iii_news&utm_medium=rss", "記憶體價飆衝擊毛利率 思科股價重挫 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000287-260203?utm_source=iii_news&utm_medium=rss", "馬斯克重組xAI四大團隊 推Macrohard叫陣微軟 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000289-260203?utm_source=iii_news&utm_medium=rss", "AI激戰 陸科企大模型升級 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000291-260203?utm_source=iii_news&utm_medium=rss", "輝達中國特供版顯卡 市場不買單 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000294-260203?utm_source=iii_news&utm_medium=rss", "AI發威 聯想去年Q4營收創高 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000295-260203?utm_source=iii_news&utm_medium=rss", "聯發科創意 自建AI超算中心 (工商產業科技)": "https://www.chinatimes.com/newspapers/20260213000317-260204?utm_source=iii_news&utm_medium=rss", "采鈺H1穩健 毛利率回神 (工商產業科技)": "https://www.chinatimes.com/newspapers/20260213000320-260204?utm_source=iii_news&utm_medium=rss", "新唐報喜 BMC訂單看到年底 (工商產業科技)": "https://www.chinatimes.com/newspapers/20260213000326-260204?utm_source=iii_news&utm_medium=rss", "AI走入實體成新變革 (工商產業科技)": "https://www.chinatimes.com/newspapers/20260213000327-260204?utm_source=iii_news&utm_medium=rss", "華新科 增持松尾電機 (工商產業科技)": "https://www.chinatimes.com/newspapers/20260213000328-260204?utm_source=iii_news&utm_medium=rss", "智生活App爆資安 16項檢測未過 (中時樂活新聞)": "https://www.chinatimes.com/newspapers/20260213000506-260114?utm_source=iii_news&utm_medium=rss", "App更新藏危機 專家籲數發部監測 (中時樂活新聞)": "https://www.chinatimes.com/newspapers/20260213000508-260114?utm_source=iii_news&utm_medium=rss", "群創南科5廠 市場點名買家是日月光 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743692", "黃仁勳：AI是史上最大規模基建 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743691", "采鈺2025年每股賺4.01元 將配息3元 調高2026年資本支出 (聯合_產經_股市)": "https://udn.com/news/story/7253/9327250", "新唐樂觀 MCU 市況 (聯合_產經_股市)": "https://udn.com/news/story/7253/9327251", "利機強化高利潤產品線 (聯合_產經_股市)": "https://udn.com/news/story/7253/9327252", "今年首起百日咳現蹤 越南返台嬰確診麻疹 (中時樂活新聞)": "https://www.chinatimes.com/newspapers/20260213000517-260114?utm_source=iii_news&utm_medium=rss", "業界：美豬難撼台豬市場 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000212-260202?utm_source=iii_news&utm_medium=rss", "卓揆喊話 明年最低工資衝3萬 (中時財經新聞)": "https://www.chinatimes.com/newspapers/20260213000525-260110?utm_source=iii_news&utm_medium=rss", "台美簽署貿易協定 美豬降關稅衝擊大？ 美豬開放4年 國產豬穩守9成市占 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743666", "鎳價大漲 不銹鋼廠前景俏 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327529", "不銹鋼市場 中長線要看終端需求 (經濟產業熱點)": "https://money.udn.com/money/story/5612/9327530", "川普挺煤電 要國防部採購 指示與發電廠訂定長期協議 (經濟國際焦點)": "https://money.udn.com/money/story/5599/9327522", "政院強調核能三原則》高階核廢料選址條例 草擬中 (工商財經要聞)": "https://www.chinatimes.com/newspapers/20260213000213-260202?utm_source=iii_news&utm_medium=rss", "推乾淨燃煤 川普令戰爭部簽煤電長約 (工商全球財經)": "https://www.chinatimes.com/newspapers/20260213000276-260203?utm_source=iii_news&utm_medium=rss", "尋「非紅」稀土礦源 經部鎖定美3州 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743670", "占比僅2.4％ 去年美製車來台不到萬輛 (自由時報財經新聞)": "https://ec.ltn.com.tw/article/paper/1743667"}};
        } catch (e) {
            EMBEDDED_DATA = { nodes: [], links: [], titleToUrl: {} };
        }

        // Data Store
        const dataStore = {
            [TARGET_DATE]: EMBEDDED_DATA
        };

        // Cosmic Orange Palette
        const ORANGE_PALETTE = ['#FF9900', '#FFB347', '#FFCC80', '#E68A00', '#CC7A00'];

        // Filter State
        let activeFilters = new Set(); // Multi-select Set
        let searchText = "";
        let highlightedNodes = new Set();
        let highlightedLinks = new Set();
        let currentLinks = [];
        let currentGraphData = null;
        const lastDragPosition = {};

        function updateHighlights() {
            highlightedNodes.clear();
            highlightedLinks.clear();

            if (activeFilters.size === 0 && !searchText) return;

            currentLinks.forEach(link => {
                const source = link.source;
                const target = link.target;

                // Keyword Match (OR logic: match ANY active filter)
                let keywordMatch = true;
                if (activeFilters.size > 0) {
                    keywordMatch = false;
                    if (link.tags && Array.isArray(link.tags)) {
                        if (link.tags.some(tag => activeFilters.has(tag))) keywordMatch = true;
                    }
                    if (link.label && activeFilters.has(link.label)) keywordMatch = true;
                }

                // Search Match
                const searchMatch = searchText ? 
                    (source.id.toLowerCase().includes(searchText.toLowerCase()) || target.id.toLowerCase().includes(searchText.toLowerCase())) 
                    : true;
                
                if (keywordMatch && searchMatch) {
                    highlightedLinks.add(link);
                    highlightedNodes.add(source);
                    highlightedNodes.add(target);
                }
            });
        }

        function triggerRenderUpdate() {
            Graph.nodeColor(Graph.nodeColor())
                 .linkColor(Graph.linkColor())
                 .linkWidth(Graph.linkWidth())
                 .linkDirectionalParticles(Graph.linkDirectionalParticles());
        }

        let Graph = ForceGraph()(graphContainer)
            .backgroundColor('#0b0b0b')
            .nodeId('id')
            .nodeRelSize(6)
            .d3Force('charge', d3.forceManyBody().strength(-900))
            .d3Force('link', d3.forceLink().id(d => d.id).distance(180))
            .d3Force('collision', d3.forceCollide().radius(40).strength(0.8))
            .nodeColor(node => ((activeFilters.size === 0 && !searchText) || highlightedNodes.has(node)) ? (ORANGE_PALETTE[Math.abs(node.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)) % ORANGE_PALETTE.length]) : 'rgba(255, 255, 255, 0.1)')
            .nodeLabel('id')
            .linkColor(link => ((activeFilters.size === 0 && !searchText) || highlightedLinks.has(link)) ? 'rgba(255, 153, 0, 0.3)' : 'rgba(255, 255, 255, 0.05)')
            .linkWidth(link => ((activeFilters.size === 0 && !searchText) || highlightedLinks.has(link)) ? (link.value ? Math.sqrt(link.value) : 1) : 0.5)
            .linkDirectionalParticles(link => ((activeFilters.size === 0 && !searchText) || highlightedLinks.has(link)) ? 2 : 0)
            .linkDirectionalParticleWidth(2)
            .linkDirectionalParticleColor(() => '#ffaa00')
            .onNodeClick(node => { onNodeClick(node); })
            .onLinkClick(link => { showToast(link.label, link.reason || ''); })
            .onNodeDrag((node) => {
                if (typeof node.x === 'number' && typeof node.y === 'number' && Number.isFinite(node.x) && Number.isFinite(node.y)) {
                    lastDragPosition[node.id] = { x: node.x, y: node.y };
                }
            })
            .onNodeDragEnd((node) => {
                const pos = lastDragPosition[node.id];
                let x = (pos && Number.isFinite(pos.x)) ? pos.x : node.x;
                let y = (pos && Number.isFinite(pos.y)) ? pos.y : node.y;
                if (!Number.isFinite(x) || !Number.isFinite(y)) {
                    x = Number.isFinite(node.x) ? node.x : 0;
                    y = Number.isFinite(node.y) ? node.y : 0;
                }
                node.x = x;
                node.y = y;
                node.fx = x;
                node.fy = y;
                delete lastDragPosition[node.id];
            });
        if (typeof Graph.onBackgroundClick === 'function') {
            Graph.onBackgroundClick(() => newsPanel.classList.remove('visible'));
        }

        // Custom Link Label Rendering
        Graph.linkCanvasObject((link, ctx, globalScale) => {
            const start = link.source;
            const end = link.target;
            if (typeof start !== 'object' || typeof end !== 'object') return;
            const sx = start.x, sy = start.y, ex = end.x, ey = end.y;
            if (typeof sx !== 'number' || typeof sy !== 'number' || typeof ex !== 'number' || typeof ey !== 'number') return;
            if (!Number.isFinite(sx) || !Number.isFinite(sy) || !Number.isFinite(ex) || !Number.isFinite(ey)) return;
            const isHighlighted = (activeFilters.size === 0 && !searchText) || highlightedLinks.has(link);

            ctx.beginPath();
            ctx.moveTo(sx, sy);
            ctx.lineTo(ex, ey);
            ctx.strokeStyle = isHighlighted ? 'rgba(255, 153, 0, 0.3)' : 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = (isHighlighted ? (link.value ? Math.sqrt(link.value) : 1) : 0.5) / globalScale;
            ctx.stroke();

            if (link.label && isHighlighted) {
                const label = link.label;
                const fontSize = Math.max(10, 14 / globalScale);
                ctx.font = `${fontSize}px 'Noto Sans TC', Sans-Serif`;
                const midX = (sx + ex) / 2;
                const midY = (sy + ey) / 2;
                const textWidth = ctx.measureText(label).width;
                const bckgDimensions = [textWidth, fontSize].map(n => n + fontSize * 0.3);
                ctx.fillStyle = '#222';
                ctx.fillRect(midX - bckgDimensions[0] / 2, midY - bckgDimensions[1] / 2, ...bckgDimensions);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#fff';
                ctx.fillText(label, midX, midY);
            }
        });

        // Custom Node Rendering
        Graph.nodeCanvasObject((node, ctx, globalScale) => {
            const x = node.x, y = node.y;
            if (typeof x !== 'number' || typeof y !== 'number' || !Number.isFinite(x) || !Number.isFinite(y)) return;
            const isHighlighted = (activeFilters.size === 0 && !searchText) || highlightedNodes.has(node);
            const label = node.id;
            const fontSize = 14 / globalScale;
            ctx.font = `${fontSize}px 'Noto Sans TC', sans-serif`;
            const textWidth = ctx.measureText(label).width;
            const bckgDimensions = [textWidth, fontSize].map(n => n + fontSize * 0.5);
            const boxX = x - bckgDimensions[0] / 2;
            const boxY = y - bckgDimensions[1] / 2;
            
            ctx.fillStyle = isHighlighted ? 'rgba(26, 26, 26, 0.9)' : 'rgba(26, 26, 26, 0.2)';
            ctx.strokeStyle = isHighlighted ? '#ff9900' : 'rgba(100, 100, 100, 0.2)';
            ctx.lineWidth = 1 / globalScale;
            ctx.fillRect(boxX, boxY, ...bckgDimensions);
            ctx.strokeRect(boxX, boxY, ...bckgDimensions);
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = isHighlighted ? '#e0e0e0' : 'rgba(100, 100, 100, 0.5)';
            ctx.fillText(label, x, y);

            node.__bckgDimensions = bckgDimensions;
        })
        .nodePointerAreaPaint((node, color, ctx) => {
            const bckgDimensions = node.__bckgDimensions;
            if (bckgDimensions && typeof node.x === 'number' && typeof node.y === 'number') {
                ctx.fillStyle = color;
                ctx.fillRect(node.x - bckgDimensions[0] / 2, node.y - bckgDimensions[1] / 2, ...bckgDimensions);
            }
        });

        // Toast Logic
        let toastTimeout;
        function showToast(title, message) {
            if (!title) return;
            toast.innerHTML = `<h3>${title}</h3><p>${message || ''}</p>`;
            toast.style.display = 'block';
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.style.display = 'none'; }, 5000);
        }

        // News Panel (entity -> related news)
        const newsPanel = document.getElementById('news-panel');
        const newsPanelTitle = document.getElementById('news-panel-title');
        const newsPanelList = document.getElementById('news-panel-list');
        document.querySelector('#news-panel .close-btn').addEventListener('click', () => { newsPanel.classList.remove('visible'); });

        // Left panel show/hide toggle
        const controlsPanel = document.getElementById('controls-panel');
        const controlsToggleTab = document.getElementById('controls-toggle-tab');
        document.getElementById('toggle-panel-btn').addEventListener('click', () => {
            controlsPanel.classList.add('hidden');
            controlsToggleTab.classList.add('visible');
        });
        controlsToggleTab.addEventListener('click', () => {
            controlsPanel.classList.remove('hidden');
            controlsToggleTab.classList.remove('visible');
        });

        function onNodeClick(node) {
            if (currentGraphData && currentGraphData.newsDatabase && currentGraphData.newsDatabase[node.id]) {
                const items = currentGraphData.newsDatabase[node.id];
                newsPanelTitle.textContent = node.id;
                const titleToUrl = currentGraphData.titleToUrl || {};
                newsPanelList.innerHTML = items.map(entry => {
                    const source = entry.source ? ` <span class="source">(${escapeHtml(entry.source)})</span>` : '';
                    const url = entry.url || titleToUrl[entry.title];
                    if (url) {
                        return `<div class="news-item"><a href="${escapeAttr(url)}" target="_blank" rel="noopener">${escapeHtml(entry.title)}</a>${source}</div>`;
                    }
                    return `<div class="news-item">${escapeHtml(entry.title)}${source}</div>`;
                }).join('');
                newsPanel.classList.add('visible');
            } else if (node.url) {
                window.open(node.url, '_blank');
            } else {
                showToast(node.id, '無相關新聞');
            }
        }
        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        function escapeAttr(s) {
            return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // --- Fetch Logic ---

        function getPreviousDate(dateStr, days) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() - days);
            return date.toISOString().split('T')[0];
        }

        async function fetchHistory() {
            // Check previous 3 days
            for (let i = 1; i <= 3; i++) {
                const prevDate = getPreviousDate(TARGET_DATE, i);
                const filename = prevDate + ".json";
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        const json = await response.json();
                        dataStore[prevDate] = json;
                        // Refresh selector
                        populateSelector();
                    }
                } catch (e) {
                    // Ignore fetch errors (likely local file system or missing file)
                    console.log(`Skipping ${filename}: ${e}`);
                }
            }
        }

        // Init Logic
        function init() {
            // On narrow viewport (e.g. mobile), start with left panel hidden so graph is full-screen
            if (window.matchMedia && window.matchMedia("(max-width: 768px)").matches) {
                controlsPanel.classList.add("hidden");
                controlsToggleTab.classList.add("visible");
            }
            populateSelector();

            // Load embedded default
            loadGraphData(TARGET_DATE);

            // Try to fetch history (if on server)
            fetchHistory();
        }

        function populateSelector() {
            // Clear existing options
            dateSelector.innerHTML = '<option value="" disabled>選擇日期...</option>';
            
            const sortedDates = Object.keys(dataStore).sort().reverse();
            sortedDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                if (date === dateSelector.value) option.selected = true;
                dateSelector.appendChild(option);
            });
            
            // If nothing selected, select first
            if (!dateSelector.value && sortedDates.length > 0) {
                dateSelector.value = sortedDates[0];
            }
        }
        
        function populateKeywords(links, nodes) {
            keywordList.innerHTML = '';
            const labels = new Set();
            (links || []).forEach(link => {
                if (link.tags && Array.isArray(link.tags)) {
                    link.tags.forEach(tag => labels.add(tag));
                }
                if (link.label) labels.add(link.label);
            });
            (nodes || []).forEach(node => {
                if (node.group) labels.add(node.group);
            });
            const sortedLabels = Array.from(labels).sort();
            sortedLabels.forEach(label => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.textContent = label;
                tag.onclick = () => toggleFilter(label, tag);
                keywordList.appendChild(tag);
            });
        }

        function toggleFilter(label, tagElement) {
            // Toggle Logic: Add or Remove
            if (activeFilters.has(label)) {
                activeFilters.delete(label);
                tagElement.classList.remove('active');
            } else {
                activeFilters.add(label);
                tagElement.classList.add('active');
            }
            
            updateHighlights();
            triggerRenderUpdate();
        }

        function loadGraphData(dateKey) {
            const graphData = dataStore[dateKey];
            if (graphData) {
                currentGraphData = graphData;
                currentLinks = graphData.links || [];
                activeFilters.clear();
                searchText = "";
                searchInput.value = "";
                updateHighlights();
                // Normalize node.val from node.size for compatibility (e.g. force-graph / rendering)
                const nodes = graphData.nodes || [];
                nodes.forEach((n, i) => {
                    if (n.size != null && n.val == null) n.val = n.size;
                });
                // Give nodes initial positions so they don't all start at center (fixes clustered view)
                const rect = graphContainer.getBoundingClientRect();
                const centerX = rect.width / 2 || window.innerWidth / 2;
                const centerY = rect.height / 2 || window.innerHeight / 2;
                const spread = Math.min(rect.width, rect.height) * 0.35 || 350;
                nodes.forEach((n, i) => {
                    const angle = (i / Math.max(nodes.length, 1)) * 2 * Math.PI + (Math.random() * 0.5);
                    n.x = centerX + spread * Math.cos(angle) + (Math.random() - 0.5) * 80;
                    n.y = centerY + spread * Math.sin(angle) + (Math.random() - 0.5) * 80;
                });
                Graph.graphData(graphData);
                if (typeof Graph.centerAt === 'function') {
                    requestAnimationFrame(() => {
                        Graph.centerAt(centerX, centerY);
                    });
                }
                populateKeywords(graphData.links, graphData.nodes);
                dateSelector.value = dateKey;
            }
        }

        dateSelector.addEventListener('change', (e) => loadGraphData(e.target.value));
        searchInput.addEventListener('input', (e) => {
            searchText = e.target.value;
            updateHighlights();
            triggerRenderUpdate();
        });

        // Start
        init();

    </script>
</body>
</html>